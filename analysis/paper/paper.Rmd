---
title: "Estimating Carrying Capacity for Juvenile Salmon using Quantile Random Forest Models"
author:
  - Kevin E. See:
      email: Kevin.See@merck.com
      institute: [biomark]
      correspondence: true
  - Michael W. Ackerman:
      email: Mike.Ackerman@merck.com
      institute: [biomark]
      correspondence: false
  - Richard A. Carmichael:
      email: Richard.Carmichael@merck.com
      institute: [biomark]
      correspondence: false
  - Sarah L. Hoffmann:
      email: Sarah.Hoffmann@merck.com
      institute: [biomark]
      correspondence: false
  - Chris Beasley:
      email: Chris.Beasley@merck.com
      institute: [biomark]
      correspondence: false
institute:
  - biomark: Biomark, Inc. 705 South 8th St., Boise, Idaho, 83702, USA
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
    bookdown::word_document2:
      fig_caption: yes
      # reference_docx: "../templates/EcologicalApplicationsTemplate.docx" # Insert path for the DOCX file
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
      number_sections: FALSE
      toc: no
      always_allow_html: true
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
    bookdown::pdf_document2:
      fig_caption: yes
      number_sections: FALSE
      toc: no
      geometry: margin=1in
      latex_engine: "xelatex"
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks2.lua
      - --lua-filter=../templates/pagebreak.lua
      includes:
        in_header: ../templates/header_manuscript.tex
    bookdown::html_document2:
      fig_caption: yes
      number_sections: FALSE
      toc: no
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
fontsize: 12pt
mainfont: Times New Roman
bibliography:
- references.bib
- packages.bib
csl: "../templates/ecological-applications.csl" # Insert path for the bib-style
# csl: "../templates/canadian-journal-of-fisheries-and-aquatic-sciences.csl"
abstract: |
  Establishing robust methods and metrics to evaluate habitat quality is critical for the recovery of endangered Pacific salmonids. A variety of modeling approaches are used for status and trend monitoring of anadromous species throughout the Pacific Northwest, USA, but current methods often fail to capture the complex relationship between fish and habitat and are often limited in predictive power beyond specific watersheds. Further, the focus on species distribution and abundance is not easily manipulated to predict carrying capacity and traditional stock-recruitment analyses are reliant on long-term data which are not always available. In this study, we developed a quantile random forest (QRF) model to  provide estimates of habitat carrying capacity for Chinook salmon parr during the summer months, at both the site and watershed scale. QRF models allow for the consideration of noisy data, correlated variables, and non-linear relationships: common features in fish-habitat datasets. We leveraged Columbia Habitat Monitoring Program (CHaMP) data to select habitat co-variates and predict capacity at those sites. We also identified a set of globally available attributes to extrapolate capacity estimate predictions throughout wadeable streams within the Columbia River basin. Total capacity estimates for watersheds closely matched estimates from alternative fish productivity models. Carrying capacity estimates based on QRF, like those presented here, provide managers a framework to guide the identification, prioritization, and development of habitat rehabilitation actions to recover salmon populations.
keywords: |
  carrying capacity; quantile regression; random forests; Chinook; quantile regression forest
highlights: |
  These are the highlights. 
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/",
  dpi = 600
)
```

```{r packages}
library(survey)
library(tidyverse)
library(QRFpaper)
library(janitor)
library(knitr)
library(pander)
library(magrittr)
library(sf)
library(english)
library(kableExtra)

theme_set(theme_bw())

options(knitr.kable.NA = '-')

# when knitting to Word, use this
# what kind of document is being created?
doc.type <- knitr::opts_knit$get('rmarkdown.pandoc.to')

if(doc.type == 'docx') {
  options(knitr.table.format = "pandoc")
}

# run this if running chunks directly
# setwd('analysis/paper')
```

```{r package-bibtex, eval = F}
knitr::write_bib(c("FSA", 
                   "Rcapture", 
                   "minerva", 
                   "quantregForest", 
                   "randomForest",
                   "missForest",
                   "survey",
                   "sf", 
                   "knitr", 
                   "rmarkdown"),
                 file = 'packages.bib')
```

```{r load-data}
hab_data = read_rds("../data/derived_data/hab_data.rds")
fish_hab = read_rds("../data/derived_data/fish_hab.rds")
hab_dict = read_rds("../data/derived_data/hab_dict.rds")
qrf_data = read_rds("../data/derived_data/qrf_data.rds")
dens_offset = read_rds("../data/derived_data/dens_offset.rds")
qrf_mod = read_rds("../data/derived_data/qrf_mod.rds")
sel_hab_mets = read_rds("../data/derived_data/sel_hab_mets.rds")
gaa_covars = read_rds("../data/derived_data/gaa_covars.rds")
mod_data_weights = read_rds("../data/derived_data/mod_data_weights.rds")
all_preds = read_rds("../data/derived_data/all_preds.rds")
spawn_rec_params = read_rds("../data/derived_data/spawn_rec_params.rds")
model_svy_df = read_rds("../data/derived_data/model_svy_df.rds")
champ_wtsds = read_rds("../data/derived_data/champ_wtds.rds")
gaa_meta = read_rds("../data/derived_data/gaa_metadata.rds")

# change some of the names of metrics for plotting purposes
sel_hab_mets %<>%
  left_join(hab_dict %>%
              select(Metric = ShortName,
                     Name) %>%
              distinct()) %>%
  mutate(Name = recode(Name,
                       'Wetted Width To Depth Ratio Avg' = 'Width:Depth Ratio',
                       'Wetted Depth SD' = 'Depth Complexity',
                       'Wetted Channel Braidedness' = 'Braidedness',
                       'Fish Cover: Total' = 'Fish Cover',
                       'Riparian Cover: Some Canopy' = 'Riparian Canopy',
                       'Wetted Width Integrated' = 'Wetted Width',
                       'Substrate < 6mm' = 'Fines',
                       # 'Substrate: D16',
                       'Channel Unit Frequency' = 'Channel Unit\nFrequency',
                       'Avg. August Temperature' = 'Avg. August Temp.',
                       'Large Wood Volume: Wetted Slow Water' = 'Large Wood\nFreq. in Pools'))
                       
```

```{r sp-rec-comp}
# rename one population
spawn_rec_params %<>%
  mutate(Population = recode(Population,
                             'Chiwawa R.' = 'Chiwawa River'))

# pull out estimates of capacity
cap_tbl = spawn_rec_params %>%
  select(Population, form, est, se, cv) %>%
  arrange(Population, form)

# make a few estimates NA (too big)
cap_tbl %<>%
  mutate_at(vars(est, se, cv),
            list(~ if_else(Population %in% c('Entiat River',
                                             'Marsh Creek',
                                             'Minam River',
                                             'Tucannon River') &
                             form == 'BevertonHolt',
                           as.numeric(NA), .)))


# pull out fitted spawner recruit curves
curve_fits = spawn_rec_params %>%
  select(Population, form, preds) %>%
  unnest(cols = "preds") %>%
  arrange(Population, form)

# define polygons for uncertainty shading
# plot_max = Inf
plot_max = 5e5
cap_poly = cap_tbl %>%
  mutate(lwrCI = est + se * qnorm(0.025),
         uprCI = est + se * qnorm(0.975)) %>%
  rowwise() %>%
  mutate(lwrCI = if_else(lwrCI < 0, 0, lwrCI),
         uprCI = if_else(uprCI > plot_max, max(est, plot_max), uprCI)) %>%
  ungroup() %>%
  left_join(spawn_rec_params %>%
              select(Population, data) %>%
              unnest(cols = "data") %>%
              group_by(Population) %>%
              summarise_at(vars(Spawners, Parr),
                           list(min = min,
                                max = max),
                           na.rm = T)) %>%
  # select(Population, form, ends_with('min'), ends_with('max'), ends_with('CI'))
  group_by(Population, form) %>%
  summarise(coords = list(tibble(x = c(0, 0, Spawners_max, Spawners_max),
                                 y = c(lwrCI, uprCI, uprCI, lwrCI)))) %>%
  ungroup() %>%
  unnest(cols = c(coords))

# which watersheds to plot?
# keep_wtsds = spawn_rec_params %>%
#   filter(form == 'QRF',
#          !is.na(est)) %>%
#   filter(!Population %in% c('Methow R.')) %>%
#   pull(Population)

keep_wtsds = c('Catherine Creek',
               'Chiwawa River',
               'Upper Grande Ronde River',
               'Hayden Creek',
               'Minam River',
               'Tucannon River',
               'Upper Lemhi',
               'Lostine River',
               'South Fork Salmon River')

# scale the parr numbers for the plot
scale_parr = 100000

spawn_rec_comp_p = spawn_rec_params %>%
  # filter out a couple populations with super poor fits
  filter(Population %in% keep_wtsds) %>%
  select(Population, data) %>%
  unnest(cols = "data") %>%
  distinct() %>%
  mutate_at(vars(Parr),
            list(~ . / scale_parr)) %>%
  ggplot(aes(x = Spawners,
             y = Parr)) +
  geom_polygon(data = cap_poly %>%
                 mutate_at(vars(y),
                           list(~ . / scale_parr)) %>%
                 # filter out a couple populations with super poor fits
                 filter(Population %in% keep_wtsds),
              aes(x = x,
                  y = y,
                  fill = form),
              alpha = 0.2) +
  geom_line(data = curve_fits %>%
              mutate_at(vars(Parr),
                        list(~ . / scale_parr)) %>%
              # filter out a couple populations with super poor fits
              filter(Population %in% keep_wtsds),
            aes(color = form),
            lwd = 1.5) +
  geom_hline(data = cap_tbl %>%
               mutate_at(vars(est),
                         list(~ . / scale_parr)) %>%
               # filter out a couple populations with super poor fits
               filter(Population %in% keep_wtsds),
             aes(yintercept = est,
                 color = form),
             linetype = 2) +
  geom_point(size = 3) +
  facet_wrap(~ Population,
             scales = 'free') +
  scale_color_brewer(palette = 'Set1',
                     breaks = c('QRF',
                                'BevertonHolt',
                                'Ricker',
                                'Hockey'),
                     labels = c('QRF', 
                                'Beverton Holt',
                                'Ricker',
                                'Hockey Stick'),
                     name = 'Model') +
  scale_fill_brewer(palette = 'Set1',
                    breaks = c('QRF',
                               'BevertonHolt',
                               'Ricker',
                               'Hockey'),
                    labels = c('QRF', 
                               'Beverton Holt',
                               'Ricker',
                               'Hockey Stick'),
                    name = 'Model') +
  labs(shape = 'Spawner\nType',
       y = 'Parr (x100,000)') +
  scale_y_continuous(breaks = scales::breaks_pretty(n = 3)) +
  theme(legend.position = 'bottom')

# # to save a different version
# ggsave('../figures/sr-test.svg',
#        spawn_rec_comp_p,
#        width = 8,
#        height = 6)

```

```{r}
cor_tab = cap_tbl %>%
  select(-se, -cv) %>%
  pivot_wider(names_from = "form",
              values_from = "est") %>%
  pivot_longer(cols = c(BevertonHolt, Ricker, Hockey),
               names_to = "form",
               values_to = "est") %>%
  filter(Population %in% keep_wtsds) %>%
  group_by(form) %>%
  summarise(r = cor(x = QRF, 
                    y = est, 
                    use = 'pairwise'))
```


# Introduction

The decline of anadromous Pacific salmonids (*Oncorhynchus spp.*) across the Pacific Northwest, USA has prompted numerous actions aimed at reversing that trend. These actions are often categorized into four H’s – harvest modification, hatchery practices, hydro-system operations, and habitat rehabilitation. Problematically, there is substantial uncertainty regarding the degree of change that can be exerted across and within these categories, and what combination of changes will most cost-effectively and sustainably reduce mortality. Freshwater habitat capacity deficits have recently been identified as a major factor directly impacting population abundance which has been largely overlooked in Columbia Basin salmonids [@Bond2018; @Hinrichsen2020; @NOAA2020]. Specifically, restoring salmonid carrying capacity through tributary rehabilitation actions has been identified as a key component of recovery efforts for salmon and steelhead (*O. mykiss*) in the Pacific Northwest, USA [@NOAA2016; @NOAA2016b]. Efforts have included increasing and improving existing habitat for both spawning adults and rearing juveniles. However, estimating habitat carrying capacity (both historic and contemporary) for various life-stages of Pacific salmon, as well as identifying important habitat characteristics that influence capacity, has been an ongoing but necessary challenge [@Bond2018; @Hinrichsen2020; @NOAA2020]. Reliable methods to better understand fish-habitat relationships and estimate capacity are necessary to identify those salmon and steelhead life-stages that are limited by habitat capacity to better direct tributary rehabilitation efforts.

When it comes to estimating carrying capacity, spawner-recruit models are the gold standard [@Moussalli1986; @Myers1999]. However, such models require a long time-series of accurate estimates of adults and juveniles, with variation in the number of adults. Such data are unavailable in most watersheds [@Cramer2009], and they do not necessarily allow one to link capacity to habitat characteristics, except perhaps at the watershed scale. Bioenergetics approaches, such as the net rate of energy intake (NREI) have been applied to salmonids to estimate capacity on the 200 - 600 m reach scale [@Wall2016]. However, there are some potential issues with how the food supply (i.e. invertebrate drift) is measured with these methods that could lead to biases in capacity estimates [@Dodrill2016] as well as difficulty in properly constraining drift depletion and inter-species competition, and computational and spatial limitation of this modelling approach [@Wall2016; @Carmichael2020]. Taking a different approach, @Sweka2010 estimated carrying capacity of Atlantic salmon (*Salmo salar*) parr using a quantile regression approach, but the only habitat covariate they included was cumulative drainage area.

Most studies that have investigated fish-habitat relationships focus on predicting a species’ distribution (presence / absence) or the average abundance or density: neither of which can be easily manipulated to predict carrying capacity. Further, many of these studies focus on only one or two measures of habitat. @Fausch1988 conducted a thorough review of attempts to predict the abundance of fish from measurable habitat covariates from 1950 to 1985, and found that the vast majority of multiple linear regression models failed to detect a significant fish-habitat signal. Since that review, there has been progress in identifying some fish-habitat relationships for several salmonid species. @Nickelson1992 demonstrated that juvenile Coho salmon (*O. kisutch*) were found in higher densities within pool habitat on the Oregon coast. Similarly, pool and pond densities were good predictors of Coho smolt densities in western Washington [@Sharma2001]. @Bryant2009 found that juvenile Coho abundance was positively related to large wood at the reach scale; however their results demonstrated a negative relationship between abundance and the number of pools. @Braun2011 similarly found positive associations between spawner densities of sockeye salmon (*O. nerka*) in the Fraser River and large wood, in addition to positive relationships to percent undercuts and percent pools. Densities of adult spawning Coho were also higher in forested areas compared to urban or agricultural areas in the Snohomish River watershed [@Pess2002]. @Mossop2006 examined juvenile Chinook salmon (*O. tshawytscha*) in the Yukon river and found positive correlations between the log of fish density and several metrics related to residual pool dimensions and large woody debris abundance as well as a negative correlation between fish density and gradient. These studies were focused on predicting observed fish densities, not necessarily capacity, and for most of them the predictive extent is limited to a particular watershed. In addition, they all assumed some form of linear fish-habitat relationship which often results in weak predictive power. 

A number of studies have used other modeling approaches to elicit fish habitat relationships. @Dunham2002 used a quantile regression approach to show a negative relationship between cutthroat trout (*O. clarkii*) densities and the width:depth ratio of a stream for the upper quantiles of trout density. The same approach was also used to map the potential extent of sole (*Solea solea*) in the English Channel and southern North Sea [@Eastwood2003]. Machine learning models such as boosted regression trees and random forests have been used to examine species biomass, diversity, and distribution for a number of different species [@Pittman2009; @Knudby2010; and @Compton2012]. The results from these studies highlight the importance and effectiveness of using techniques that can accommodate non-linear fish habitat relationships and provide motivation for furthering research in this realm.. 

For the purposes of this paper, we define carrying capacity as the maximum number of individuals that can be supported given the quantity and quality of habitat available at a given life-stage. We assume that higher observed relative densities within a given life stage are a function of habitat quantity and quality. Furthermore, we assert that observed fish density is a poor proxy of habitat capacity owing to both a paucity of individuals, especially for threatened or endangered species, and the existence of unmeasured variables that may serve to limit capacity. To address this, we have developed a model to estimate juvenile rearing capacity for Pacific salmon in wadeable streams based on quantile random forest (QRF) [@Meinshausen2006] models using measurements of fish abundance and density and habitat characteristics. QRF models combine the theory and justification of quantile regression modeling [@Koenker1978; @Cade2003] with the flexibility and framework of random forest models [@Breiman2001]. They account for unmeasured variables and can be used to describe the entire distribution of predicted fish densities for a given set of habitat conditions, not just the mean expected density. Random forest models have been shown to outperform more standard parametric models in predicting fish-habitat relationships in other contexts [@Knudby2010]. Quantile random forests share many of the benefits of random forest models, such as the ability to capture non-linear relationships between independent and dependent variables, naturally incorporate interactions between covariates, and work with untransformed data while being robust to outliers [@Prasad2006]. In addition, quantile regression models have been used in a variety of ecological systems to estimate the effect of limiting factors [@Terrell1996; @Cade2003].

The fish abundance/density and habitat data used to fit the QRF model presented here were available from seven watersheds within the interior Columbia River basin, Pacific Northwest, USA. Within the interior Columbia River basin two major runs of Chinook salmon occur, stream-type (i.e., spring/summer run) and ocean-type (i.e., fall run), each characterized by different life history characteristics. Stream-type Chinook salmon adults enter freshwater from the ocean earlier in the year, spawn in the upper reaches of a watershed, and the juveniles rear for up to 16 months in freshwater before entering the ocean as smolts. Ocean-type Chinook salmon adults enter freshwater later (e.g., fall or winter) spawn lower in the watershed, and the juveniles may spend between several weeks and six months in freshwater before migrating to the ocean as subyearlings. Here, we focus on stream-type Chinook salmon, and in particular the juvenile summer rearing period during low flow, during which juveniles are often termed parr, referring to the camouflage markings that occur on their sides during this life-stage. Data presented here are from Chinook salmon populations in the Upper Columbia River spring-run and Snake River spring/summer-run Evolutionary Significant Units (ESU). The Upper Columbia spring-run ESU is listed as endangered under the Endangered Species Act, the Snake River spring/summer-run is listed as threatened [@NOAA2016; @NOAA2016b]. Hereafter, we refer to both ESUs simply as Chinook salmon.  

In this study, we developed a QRF model to: 

* Identify measured habitat characteristics that are most strongly associated with observed Chinook salmon parr abundance and density,
* Use paired fish and habitat measurements to elicit fish-habitat relationships for those habitat characteristics identified as important for determining fish abundance and density,
* Predict contemporary habitat carrying capacity at all sites where the important habitat characteristics are measured (i.e., CHaMP sites within the Columbia River basin),
* Extrapolate capacity predictions at CHaMP sites across a watershed using globally available attribute data to estimate the Chinook salmon parr capacity of that watershed, and
* Validate estimates of carrying capacity from our approach across multiple watersheds using independent estimates of capacity (e.g., spawner-recruit relationships).

Our study incorporates multiple measures of stream habitat to estimate fish-habitat relationships that encompass the collinear nature of most stream habitat metrics and can be used to predict carrying capacity. Our approach moves across several spatial scales, inferring fish-habitat relationships from detailed, localized habitat data and extrapolating capacity predictions across wide swaths of unsampled locations. Additionally, this approach for estimating life-stage specific habitat-based carrying capacity can be used to quantitatively identify the magnitude of tributary habitat rehabilitation necessary to support de-listing. Given the multitude of (often correlated) habitat metrics and the potentially non-linear fish habitat relationships that define capacity as a function of habitat, we explore the application of QRF modeling to habitat capacity estimation, validated using data from Columbia River Chinook salmon. For perhaps the first time, the necessity of tributary habitat rehabilitation can be demonstrated and the magnitude of required change can be placed in context with the other "H's."

# Methods

## Study Site

Habitat data used in our study were collected from `r as.character(english(n_distinct(hab_data$Watershed)))` watersheds within the interior Columbia River basin, Pacific Northwest, USA (Figure \@ref(fig:wtsd-map)). The Columbia River basin covers more than 668,000 km$^2$ draining large portions of Idaho, Oregon, and Washington, and smaller portions of Montana, Nevada, Utah, and Wyoming, as well as the southeastern portion of British Columbia. The habitat data used to populate the QRF model were collected by the Columbia Habitat Monitoring Program (CHaMP) [@Volk2017] and were downloaded from https://www.champmonitoring.org. Data from the following `r as.character(english(n_distinct(hab_data$Watershed)))` CHaMP watersheds were used in this study: `r paste(sort(unique(hab_data$Watershed))[-length(unique(hab_data$Watershed))], collapse = ', ')` and `r sort(unique(hab_data$Watershed))[length(unique(hab_data$Watershed))]`. Juvenile density and abundance data were collected in a subset of `r as.character(english(n_distinct(fish_hab$Watershed)))` watersheds (see Table \@ref(tab:fish-hab-sites) and Figure \@ref(fig:wtsd-map)), at CHaMP survey reaches and were graciously provided by a number of agencies and projects, including the Integrated Status and Effectiveness Monitoring Project [@Volk2017].

## Data

CHaMP sites are 200 m to 600 m reaches within wadeable streams across select watersheds within the interior Columbia River basin. The sites were selected based on a spatially balanced generalized random tesselation stratified sample selection algorithm [@Stevens1999; @Stevens2004]. Habitat data within CHaMP sites were collected using the CHaMP protocol [@CHaMP2016] which calls for field data collection during the low-flow period, typically from June through October. CHaMP habitat data include, but are not limited to, measurements describing channel complexity, channel units, disturbance, fish cover, large woody debris, riparian cover, stream size (depth, width, discharge), substrate, temperature, macroinvertebrate productivity, and water quality. 

Juvenile fish surveys were conducted for Chinook salmon parr during the summer low-flow season at many of the same sites surveyed using the CHaMP protocol. Survey methods included mark-recapture, three-pass removal sampling, two-pass removal sampling, single-pass electrofishing, and snorkeling. These data were used to estimate Chinook salmon parr abundance at all CHaMP sites where fish survey data were available. Three-pass removal estimates used the Carle-Strub estimator [@Carle1978], following advice from @Hedger2013. Two-pass removal estimates used the estimator described by @Seber2002. Mark-recapture estimates used Chapman’s modified Lincoln-Peterson estimator [@Chapman1951] and were deemed valid if they met the criteria described in @Robson1964. These estimates were made using the *removal* function from the *FSA* package [@R-FSA] or the *closedp.bc* function from the *Rcapture* package [@R-Rcapture] in R software [@Rsoftware2019]. Snorkel counts were transformed to abundance estimates using paired snorkel-electrofishing sites to calibrate snorkel counts. For sites with invalid estimates or that were sampled with a single electrofishing pass, we developed an estimate of capture probability based on valid estimates, using a binomial generalized linear mixed effects model. Fixed effects were species, wetted width of the site, density of fish caught on the first pass and all possible two-way interactions. We included a random effect for fish crew / watershed. We used this model to predict abundances based on the number of fish caught on the first pass and any other covariates.

Abundance estimates at all sites were then translated into linear (parr/m) fish densities which were paired with the associated CHaMP habitat data. For sites that were sampled in multiple years, only the fish and habitat data from the year with the highest observed fish density was retained to avoid possible pseudo-replication, while remaining consistent with our goal of estimating carrying capacity. After removing duplicate samples, our initial dataset contained `r n_distinct(qrf_data$Site)` unique sites with paired fish-habitat data (Table \@ref(tab:fish-hab-sites)). 

## Habitat Covariate Selection

A key step in developing a QRF model to predict fish capacities was selecting the habitat covariates to include in the model. The CHaMP program generated more than 100 habitat metrics at each site, many of which were correlated with each other to one degree or another, as is often the case with stream habitat variables. We sought to include a small set of covariates that were not overly redundant (i.e., not highly correlated), described many aspects of stream habitat (e.g., substrate, temperature, complexity, etc.) and were highly associated with the observed fish densities, presumably because they contained information about what types of habitat fish sought or avoided. Full details of how covariates used in the QRF model were selected can be found in Appendix S1. 

## QRF Model Fit

Using the selected habitat covariates (Table \@ref(tab:select-mets-table)), we fit a QRF model to predict habitat rearing capacity for Chinook salmon parr during summer months using the natural log of fish densities as the response. After constructing a random forest, predictions of the mean response can be made by averaging the predictions of all trees, similar to the expected value predictions from a statistical regression model. The individual predictions from each tree, viewed collectively, describe the entire distribution of the predicted response; therefore, the random forest model can be used in the same way as other quantile regression methods to predict any quantile of the response. There were missing values for some habitat data; thus, any site visit with more than three missing covariates was removed from the dataset and the remaining missing habitat values were imputed using the *missForest* R package [@R-missForest; @Stekhoven2012]. We fit the QRF models using the *quantregForest* function from the *quantregForest* package [@R-quantregForest] in R software [@Rsoftware2019], incorporating data from `r nrow(qrf_data)` records (paired fish-habitat data) and `r as.character(english(nrow(sel_hab_mets)))` habitat covariates (`r round(nrow(qrf_data) / nrow(sel_hab_mets), 1)` data points per covariate) (Table \@ref(tab:select-mets-table)). The 90th quantile of the predicted distribution was used as a proxy for carrying capacity following the suggestion of @Sweka2010, and to avoid higher quantiles that draw from the very upper tails of observed fish density, where the variability of predictions may be influenced by small sample size issues.

After model fitting, the QRF model was then used to predict capacity at sites with measurements of the habitat covariates that were used to fit the model. In our case, this includes all sites within CHaMP basins in the interior Columbia River basin. For CHaMP sites that were sampled in multiple years, we first calculated the mean for each habitat metric among years to make predictions. In total, we generated `r filter(all_preds, is.na(chnk_per_m_se)) %>% summarise(n_sites = n_distinct(Site)) %>% pull(n_sites)` predictions of Chinook salmon parr capacity, during summer months, for the following basins: Entiat, Grande Ronde (including Minam), John Day, Lemhi, Methow, South Fork Salmon, Tucannon, Wenatchee and Yankee Fork Salmon. CHaMP sampled between 1 and 28% of the Chinook domain within these watersheds, with an average of 11%. 

## Extrapolating to Other Sites

To predict capacity at larger spatial scales, such as the watershed or population, we developed an extrapolation model based on globally available attributes (GAA) which were available for the entirety of tributary habitat utilized by a given population. The GAA data used here was taken from the list of generalized random tesselation stratified master sample sites that the CHaMP sites were originally selected from [@Larsen2008; @Larsen2016]. Possible covariates included temperature range, elevation, watershed, the first principal component of a natural feature classification and human disturbance classificaiton [@Whittier2011], the square root of cumulative drainage area, stream power, slope, channel type, bankfull width and average August temperature (Table \@ref(tab:gaa-covars)). The natural log of the CHaMP site capacity predictions (parr/m) was used as the response variable in a multiple linear regression model that incorporated the design weights of the CHaMP sites using the *svyglm* function from the *survey* package [@R-survey] in R software [@Rsoftware2019]. The design weights are generated from how much of the watershed each site is meant to represent. Because the CHaMP sites were selected from strata that usually comprised unequal portions of that watershed, these weights must be accounted for to lead to unbiased model coefficients [@Nahorniak2015].  We fit two different extrapolation models, one that included watershed as a covariate for use in predicting capacity within CHaMP watersheds, and one that did not for predicting everywhere else. We then made predictions of linear capacity at all master sample sites throughout the interior Columbia River basin, generally spaced about one kilometer apart.

To summarize capacity at larger scales, the mean linear capacity (e.g., parr/m) of the master sample points along a particular tributary is multiplied by the length of that tributary. We first restricted the upstream limit of master sample points and lengths of streams to those within the domain of spring/summer-run Chinook salmon, as defined by StreamNet ([http://www.streamnet.org](http://www.streamnet.org)) or using expert opinion from local biologists, and the downstream limit by when streams were no longer wadeable (often by some combination of estimated bankfull width and cumulative drainage area). The capacities of various tributaries could then be summed to estimate capacity at almost any spatial scale. 

## Model Validation

Spawner-recruit data from several watersheds within the interior Columbia River basin were compiled to validate the extrapolated QRF estimates of Chinook salmon parr capacity. Some watersheds had direct estimates of parr, while some had estimates of smolts and pre-smolts (i.e., fall emigrants) from rotary screw traps. For the latter, estimates of parr were calculated using estimates of over-winter survival. A series of spawner-recruit functions were then fit to this data including Beverton-Holt, Ricker, and hockey stick [@Froese2008], using the *FSA* package [@R-FSA] in R. Estimates of capacity from each of these spawner-recruit curves were compared with QRF estimates of capacity for the same regions.

All code and data for the analyses presented here can be found in a [GitHub repository](https://github.com/KevinSee/QRFpaper).

# Results

## Habitat Covariate Selection

We categorized `r filter(hab_dict, MetricGroupName == "Visit Metric") %>% nrow()` habitat measurements collected using the CHaMP habitat protocol [@CHaMP2016] into `r n_distinct(hab_dict$MetricCategory[!is.na(hab_dict$MetricCategory)]) %>% english %>% as.character` habitat categories, and for each habitat covariate the Maximal Information Criteria (MIC) value was calculated based on the strength of association between the habitat covariate and the response variable, parr density (parr/m) (See Appendix S1 for further details). We chose the following `r as.character(english(nrow(sel_hab_mets)))` CHaMP habitat covariates to fit the QRF model: wetted width, observed discharge, average August temperature, wetted width:depth ratio, percent fines less than 6 mm, total percent fish cover, channel unit frequency, standard deviation of the wetted depth, frequency of large wood in pools, percent riparian canopy cover, lower quantile of substrate size (D16) and braidedness (Table \@ref(tab:select-mets-table)). 

## QRF Model

A QRF model was fit using those metrics and the *quantregForest* package [@Meinshausen2006] in R [@Rsoftware2019] and the 90th quantile of the predicted distribution was used as a proxy for carrying capacity. After model fit, we examined the relative importance of each habitat covariate included in the model (Figure \@ref(fig:rel-imp-figure)), quantified by the average decrease in residual sum of squares for splits on that variable amidst the trees in the random forest, implemented by the *importance* function from the *randomForest* package [@randomForest2002]. Moreover, QRF models allow one to visually examine the marginal effect of each habitat covariate on the quantile of interest using partial dependence plots. These plots show the marginal effect of changing a single habitat covariate while maintaining all other covariates at their mean values (Figure \@ref(fig:pdp-figure)). However, given that many habitat metrics are somewhat correlated, these marginal effects are often not independent of one another and care should be taken when interpreting them. After model fitting, the QRF model was used to predict habitat capacity at all CHaMP sites within the interior Columbia River basin. 

## Extrapolating to Other Sites

We fit a linear regression extrapolation using QRF-based predictions of capacity at all CHaMP sites as the response, and various GAAs as the independent variables. The coefficients for the extrapolation model can be found in Table \@ref(tab:gaa-covars) and the summary of the model fit in Table \@ref(tab:extrap-r2-table). From this, we calculated estimates of capacity at every master sample point in the Columbia River basin, each representing roughly one kilometer of stream length.

## Model Validation

Estimates of Chinook salmon parr capacity from the QRF and extrapolation models were comparable to independent estimates from spawner-recruit data (Table \@ref(tab:sr-table), Figure \@ref(fig:sr-figure)). QRF estimates had overlapping confidence intervals with one or more of the Beverton-Holt, Ricker, or hockey stick model estimates in each of the `r as.character(english(length(keep_wtsds)))` locations where comparisons were possible (Figure \@ref(fig:sr-figure)). Potential additional uncertainty was not accounted for in estimates of spawners-per-redd or spawners-per-parr, which would increase the confidence intervals around spawner-recruit estimates and the overlap among estimates. Correlations between parr capacity estimates from the QRF model and spawner-recruit models ranged from 0.710 (Beverton-Holt) to 0.966 (Ricker). This favorable comparison provides strong validation as the spawner-recruit estimates of Chinook salmon parr capacity were developed from completely independent datasets and using entirely different methods.

# Discussion

## A Tool to Estimate Habitat Capacity

In this study, we developed a novel approach to estimate the capacity of habitat to support Chinook salmon parr during summer months and in wadeable streams. Our model can be used to quantify juvenile rearing capacity in Chinook salmon watersheds or populations and, in turn, quantify the magnitude of tributary habitat rehabilitation necessary to support Endangered Species Act delisting. The QRF and extrapolation models presented here provide useful tools towards the prioritization, implementation, and evaluation of habitat rehabilitation actions to recover depleted salmon populations. Moreover, these models can be applied to multiple stages within the life cycle (e.g., parr, smolt, adult). Estimates of habitat carrying capacity for multiple life stages will allow biologists and managers to identify what life-stage specific habitat patches may be limiting. As an example, QRF models and associated extrapolation models may demonstrate that habitat for a given population is sufficient to support adult spawning required to achieve delisting targets, but that juvenile rearing capacity may not be sufficient to support the target abundance. In such a case, habitat rehabilitation actions may be most cost-effectively and sustainably directed towards improving juvenile rearing habitat. Models to estimate habitat carrying capacity for multiple life stages will help to better direct habitat restoration actions and help guide not only the type of action, but also the location at which an action is performed.

The favorable comparison between QRF estimates of carrying capacity and the spawner-recruit based estimates in select watersheds helps support and validate this approach. Although built from completely different data, when these multiple lines of evidence converge it lends credence to the QRF capacity prediction results.

There are two aspects that make this approach "data hungry", meaning a large dataset is needed to fit a QRF model like this. First, random forest models generally require more data that parametric models, due to the lack of parametric distribution assumptions and the lack of an assumed form of the relationship between dependent and independent variables. Second, it takes larger data sets to accurately predict the lower and higher quantiles in a quantile regression framework. For example, if a data set consisted of thousands, rather than hundreds, of data points, a researcher might feel comfortable using the 95th or the 98th quantile as a proxy for capacity, rather than the 90th. Our data set consisted of `r n_distinct(qrf_data$Site)` sites, across a variety of habitats and years, providing contrast in all the habitat covariates and presumeably satisfying the data hungriness of a QRF model, based on our validation with spawner-recruit data. 

## Biological Expectations from QRF Model

The results of the QRF parr capacity model for Chinook salmon meet many biological expectations. Focusing on the partial dependence plots (Figure \@ref(fig:pdp-figure)), the QRF model predicts capacity to increase when the wetted width, discharge and the width:depth ratio grow, when temperatures are cooler [@Bjornn1991; @Raleigh1986; @Brett1952], when there is less fine sediment [@Allen2000; @Bjornn1991; @Hillman1987], when there is more fish cover [@Holecek2009; @Bjornn1991; @Hillman1987], when channel unit frequency increases and when the standard deviation of the wetted depth (a proxy for streambed complexity) increases. These are all patterns that emerged from the fish-habitat data, and where available, match those fish-habitat relationships identified qualitatively in other studies [@Mossop2006]. 

The biggest driver of capacity identified in this study is stream size, whether measured by wetted width or discharge, which should be unsurprising since we are using fish per meter as our response. In many ways, these metrics define habitat quantity; however, other metrics used in our QRF model help define habitat quality, such as cooler temperatures in August, less pool-tail fine sediment, and higher channel unit frequencies (a measure of habitat complexity and surrogate for the number of pool-riffle sequences or potential sheer areas providing feeding zones), and fish cover. 

## Extrapolation Model

Fish are mobile creatures and determining the appropriate spatial scale to estimate how their capacity may be determined by habitat characteristics is important. In the summer, for Chinook salmon parr, our fish data clearly shows movement between multiple channel units (e.g., pool, riffle, run), suggesting that fish are utilizing habitat at a larger scale than the channel unit. However, it is unlikely that they are moving up and down the entire watershed and we believe the 200 - 600 m reaches used in this study are an appropriate scale to capture the fish-habitat relationships that define carrying capacity. At the same time, we acknowledge that managers, life-cycle modelers, and others are often interested in capacity estimates at larger spatial scales. While our QRF model can provide site-specific estimates of carrying capacity derived from paired fish-habitat data, our extrapolation model allows for estimates at larger spatial extents, such as watershed and population levels. This is an efficient technique to leverage existing relationships for meaningful management decisions.

Our extrapolation model was focused on extrapolating to other master sample points, because that is the dataset available to us, but the methodology could be improved. Extrapolating to reaches on a stream network, as opposed to points on the landscape, could improve the interpretability of the results. This would require a stream network with relevant attributes attached to each reach, similar to the GAAs we used. Another approach could be to move towards sampling habitat in a more spatially continuous fashion, covering most or all of a watershed, and building a QRF model from that dataset. Even if the fish data were not collected continuously, estimates of capacity could be made directly from the QRF model across the entire stream network without the need for an extrapolation model.

One of the potential downsides to the extrapolation approach used here is that the GAAs generally do not change through time, and therefore may not reflect the dynamic nature of changing stream habitat. While the QRF model itself uses habitat characteristics that can be observed to change over the course of several years, most GAAs are static, generally derived remotely or from another model. This is the nature of extrapolating to such large spatial extents; it can be impossible to gather actual habitat data on such a scale, but with improvements in remote sensing, spatially continuous data (modeled or measured) may be on the horizon [@Tonina2019]. 

<!-- Do we need any more in this section? I commented out the paragraph below... -->

<!-- While the Columbia River basin is an excellent candidate for this type of extrapolation given the wealth of CHaMP data, application of this technique to areas with limited habitat data may be considerably more challenging. On-the-ground habitat data collection is costly, time-consuming, and often not reproducible; thereby limiting the effectiveness of this type of extrapolation.  Additionally, the extrapolation model relies on Global Available Attribute (GAA) data which ….  -->

<!-- Add here why GAA are messy. And then anything else which may be a consideration for using the extrapolation model moving forward.  -->

## The Future: Improving Habitat Data

<!-- Discussion of improving habitat data to possibly avoid extrapolation. Collect cheaper/better spatially continuous habitat data. -->

<!-- I have no idea if this is what you are looking for so feel free to delete if I am way off base.  -->

Given the cost/extent of data necessary for QRF extrapolation in watersheds outside of the Columbia River basin, there is a pressing need to develop new tools for habitat analyses. Unmanned Aerial Systems (UAS or drones, commonly) are gaining popularity in wildlife and ecosystem monitoring for their ease of use, safety, accessibility, and cost-efficiency [@Jones2006; @Chabot2015]. UAS produce high-resolution, permanent data at a fraction of the cost of on-the-ground habitat sampling. Advances in imaging techniques (e.g., multispectral imaging) and post-processing (e.g., automation of data collection from imagery) are already demonstrating increase in the efficiency and accuracy of data collection [@Whitehead2014; @LeCun2015; @Weinstein2018]. Further, developments in Light Detection and Ranging (LiDAR) technology have allowed for the characterization of watershed scale geomorphologic and hydraulic variables not previously possible [@Tonina2019; @McKean2008]. 

Development of a standardized protocol to incorporate remotely sensed data (LiDAR, aerial imagery) into the collection of habitat metrics would greatly increase the broadscale application of QRF. Rapid advances in drone technology further improve upon traditional habitat data collection by leveraging 1) sub-meter global navigation satellite system (GNSS) receivers; 2) cost-effective drone imagery collection, image stitching, and photogrammetry; and 3) semi-automated to automated data post-processing. All data collection efforts would be georeferenced and topologically compatible to increase repeatability of methods and data collection locations; a primary criticism of previous CHaMP survey efforts. The implementation of such a protocol would circumvent the need to extrapolate by collecting data for individual channel units in a rapid manner using remote sensing technologies, thereby reducing labor, providing a cost-effective tool for habitat data collection supporting status and trend evaluation and model products to better inform habitat rehabilitation prioritization and planning.

## Conclusions and Next Steps

<!-- The beginning of the following paragraph may need some word-smithing -->

If a species' carrying capacity is defined or constrained, at least in part, by the habitat in which it lives, then illuminating statistically how such habitat impacts carrying capacity can lead to understanding how a species interacts with its environment. This understanding could be of crucial importance in the realm of conservation when dealing with an endangered or threatened species, but species/habitat interactions are a core element of ecological studies more generally. We have demonstrated how a quantile regression approach, coupled with a random forest framework, can be used to estimate these relationships, and predict a habitat's capacity. As large ecological datasets become more accessible, and the ability to measure large swaths of habitat more feasible, we believe this approach has many potential applications, from the North American breeding bird survey to groundfish trawl surveys. The framework could also be applied to depleted, non-migratory, and isolated populations (e.g., desert pupfish *Cyprinodon macularius*) to identify limiting factors in populations and/or determine whether a given habitat patch could support a viable population if limiting factors were addressed. Capacity estimates could also be used to evaluate potential translocation sites to determine if those sites could support an abundance considered viable before investing in translocation efforts.

# Acknowledgements

Model development efforts have been funded by the Bonneville Power Administration through projects 2003-017-00 and 2011-006-00 and by the Bureau of Reclamation and Idaho Office of Species Conservation through contract BOR002 16. Fish sampling work in the Lemhi River was also funded through the Idaho Office of Species Conservation through the Pacific Coast Salmon Recovery Fund. Special thanks to staff from the following agencies for providing data to calculate Chinook salmon parr abundance and density estimates: Columbia River Inter-Tribal Fish Commission, Oregon Department of Fish and Wildlife, and U.S. Fish and Wildlife Service. The models in this study were improved by conversations with Eric Buhle.

<!-- The following line inserts a page break  -->
\newpage

# Literature Cited 
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

\newpage

# Tables

<div id="tables"></div>

```{r fish-hab-sites}
qrf_data %>%
  tabyl(Watershed) %>%
  adorn_totals() %>%
  adorn_pct_formatting() %>%
  rename(`n Sites` = n,
         Percent = percent) %>%
  kable(caption = 'The number of unique sites, by watershed, with paired fish-habitat data used to populate the spring/summer-run Chinook salmon parr capacity QRF model',
        booktabs = T) %>%
  kable_styling()
  
```

\newpage

```{r select-mets-table, eval = T}
qrf_mod$importance %>%
  as_tibble(rownames = 'ShortName') %>%
  rename(imp = IncNodePurity) %>%
  arrange(desc(imp)) %>%
  mutate(Rank = 1:n()) %>%
  select(-imp) %>%
  left_join(hab_dict %>%
              select(-Name) %>%
              inner_join(sel_hab_mets %>%
                           rename(ShortName = Metric)) %>%
              mutate(Name = str_replace(Name, '\n', ' '))) %>%
  filter(MetricGroupName != 'Tier 1 Summary') %>%
  select(Rank,
         Metric = Name,
         `Metric Category` = MetricCategory,
         Description = DescriptiveText) %>%
  kable(caption = "Habitat metrics and descriptions of metrics included in the QRF model to predict spring/summer-run Chinook salmon parr capacity. Metrics are ranked in order of relative importance.",
        booktabs = T,
        format.args = list(width = c(2, 10, 10, 50))) %>%
  kable_styling() %>%
  column_spec(4, width = '3in')
  
```

\newpage

```{r gaa-covars, eval = T}
tibble(Covariate = gaa_covars) %>%
  left_join(gaa_meta %>%
              select(Covariate = FieldName,
                     Name = DisplayName,
                     Units,
                     SpatialScale)) %>%
  mutate(Units = if_else(Units == "na",
                         as.character(NA),
                         Units),
         Units = if_else(grepl('\\^2', Units),
                         str_replace(Units, '\\^2', '$^2$'),
                         Units)) %>%
  mutate(Name = if_else(Covariate == 'S2_02_11' & is.na(Name),
                        'NorWeST Aug. Temperature',
                        Name),
         Units = if_else(Covariate == 'S2_02_11',
                                'C',
                                Units),
         SpatialScale = if_else(Covariate == 'S2_02_11',
                                'Reach-2km',
                                SpatialScale)) %>%
  left_join(model_svy_df$mod_full[[1]] %>%
              summary() %>%
              coefficients() %>%
              as_tibble(rownames = "Covariate") %>%
              select(1:3)) %>%
  select(-Covariate) %>%
  rename(`Spatial Scale` = SpatialScale,
         Covariate = Name) %>%
  kable(caption = "Globally available attribute (GAA) habitat covariates used to extrapolate quantile random forest (QRF) model predictions of spring/summer-run Chinook parr capacity to a larger scale (e.g., watershed, population), with their coefficients and standard errors.",
        booktabs = T, 
        escape = F,
        digits = 3) %>%
  kable_styling()

```

\newpage

```{r extrap-r2-table, eval = T}
model_svy_df %>%
  ungroup() %>%
  mutate(n_full = map_dbl(data,
                          .f = nrow),
         k_full = map_dbl(mod_full,
                          .f = function(x) {
                            names(x$coefficients)[!grepl('Intercept', names(x$coefficients))] %>%
                              length
                          }),
         r_full = map_dbl(mod_full,
                          .f = function(x) {
                            cor(x$y, x$fitted.values)
                          }),
         r2_full = r_full^2,
         r2_adj_full = 1 - ( ( (1 - r2_full) * (n_full - 1) ) / (n_full - k_full - 1) )) %>%
  mutate(n_no_champ = map_dbl(data,
                              .f = nrow),
         k_no_champ = map_dbl(mod_no_champ,
                              .f = function(x) {
                                names(x$coefficients)[!grepl('Intercept', names(x$coefficients))] %>%
                                  length
                              }),
         r_no_champ = map_dbl(mod_no_champ,
                              .f = function(x) {
                                cor(x$y, x$fitted.values)
                              }),
         r2_no_champ = r_no_champ^2,
         r2_adj_no_champ = 1 - ( ( (1 - r2_no_champ) * (n_no_champ - 1) ) / (n_no_champ - k_no_champ - 1) )) %>%
  select(response, starts_with("r2")) %>%
  gather(type, r2, -response) %>%
  mutate(model = if_else(grepl('no_champ', type),
                         'non-CHaMP',
                         'CHaMP'),
         type = if_else(grepl('adj', type),
                        'Adjusted R2',
                        'R2')) %>%
  spread(type, r2) %>%
  mutate(response = recode(response,
                           'chnk_per_m' = 'fish/m',
                           'chnk_per_m2' = 'fish/m$^2$')) %>%
  filter(response == "fish/m") %>%
  select(Model = model,
         Response = response,
         `$r^2$` = R2, 
         `Adjusted $r^2$` = `Adjusted R2`) %>%
  kable(caption = "Summary of extrapolation model fits, split by whether the extrapolation model used CHaMP watershed as a covariate or not.",
        escape = F,
        booktabs = T,
        digits = 3) %>%
  kable_styling()
  
```

\newpage

```{r sr-table, eval = T}
spawn_rec_params %>%
  select(Population, data) %>%
  unnest(data) %>%
  group_by(Population) %>%
  summarise(`n Yrs` = n_distinct(BroodYear),
            Spawner_type = unique(Spawner_type)) %>%
  select(Population, `n Yrs`, Spawner_type) %>%
  mutate(Spawner_type = recode(Spawner_type,
                               'total spawners' = 'Spawners',
                               'redd counts' = 'Redds')) %>%
  rename(`Adult Data` = Spawner_type) %>%
  mutate(`Parr Data` = if_else(grepl('Chiwawa', Population),
                               'Parr Surveys',
                               'RST')) %>%
  full_join(spawn_rec_params %>%
              mutate(prnt_val = paste0(prettyNum(round(est), big.mark = ','), ' (', round(cv, 3), ')')) %>%
              select(Population, form, prnt_val) %>%
              mutate(form = recode(form,
                                   'BevertonHolt' = 'Beverton Holt',
                                   'Hockey' = 'Hockey Stick')) %>%
              mutate(form = factor(form,
                                   levels = c('Beverton Holt',
                                              'Ricker',
                                              'Hockey Stick',
                                              'QRF'))) %>%
              spread(form, prnt_val)) %>%
  filter(Population %in% keep_wtsds) %>%
  mutate(Population = recode(Population,
                             'Chiwawa R.' = 'Chiwawa River')) %>%
  kable(caption = "Estimates of parr capacity from both spawner-recruit data (Beverton-Holt, Ricker, hockey stick) and from extrapolated estimates of parr capacity from the quantile random forest (QRF) model. Numbers in parentheses are coefficients of variation.",
        booktabs = T) %>%
  kable_styling() %>%
  # kable_styling(latex_options = c('scale_down')) %>%
  column_spec(1, width = "1in") %>%
  column_spec(c(5:8), width = "0.5in")

```

\newpage

# Figures

<div id="figures"></div>

```{r wtsd-map, fig.cap = "Watersheds with CHaMP habitat data. Watersheds in black also contain paired fish data. Watershed names are: 1 - Entiat, 2 - John Day, 3 - Lemhi, 4 - Methow, 5 - Minam, 6 - Secesh, 7 - South Fork Salmon, 8 - Tucannon, 9 - Upper Grande Ronde, 10 - Wenatchee, 11 - Yankee Fork."}
knitr::include_graphics('../figures/ChampWtds.png')
# knitr::include_graphics('../figures/ChampWtds.jpeg')
```

\newpage

```{r rel-imp-figure, fig.cap = "Relative importance of each habitat covariate included in the quantile random forest (QRF) model to predict habitat capacity, during summer months, for spring/summer-run Chinook salmon parr"}
qrf_mod$importance %>%
  as_tibble(rownames = 'ShortName') %>%
  rename(imp = IncNodePurity) %>%
  mutate(imp = (imp / max(imp)) * 100) %>%
  arrange(desc(imp)) %>%
  left_join(hab_dict %>%
              filter(is.na(MetricGroupName) | MetricGroupName != 'Tier 1 Summary')) %>%
  select(-Name) %>%
  left_join(sel_hab_mets %>%
              select(ShortName = Metric,
                     Name)) %>%
  mutate_at(vars(ShortName, Name, MetricCategory),
            list(~ fct_reorder(., .x = imp))) %>%
  ggplot(aes(x = Name,
             y = imp)) +
  # geom_col(aes(fill = MetricCategory)) +
  # scale_fill_brewer(palette = 'Set2') +
  geom_col(fill = 'gray40') +
  coord_flip() +
  labs(x = 'Metric',
       y = 'Relative Importance')
  
```

\newpage

```{r pdp-figure, fig.cap = "Partial dependence plots for the spring/summer-run Chinook salmon parr capacity quantile random forest (QRF) model, depicting how parr capacity shifts as each habitat metric changes, assuming all other habitat metrics remain at their mean values. Tick marks along the X-axis depict observed values."}
plot_partial_dependence(rf_mod = qrf_mod,
                        data = qrf_data,
                        data_dict = hab_dict %>%
                          select(-Name) %>%
                          inner_join(sel_hab_mets %>%
                                       select(ShortName = Metric,
                                              Name)),
                        type = 'quantile',
                        pred_quantile = 0.9,
                        log_transform = T,
                        log_offset = dens_offset,
                        scales = 'free') +
  labs(y = 'Capacity Prediction (per m)') +
  scale_color_grey(start = 0.5, end = 0.5) +
  theme(legend.position = 'none',
        strip.text = element_text(size = 6))
```

\newpage

```{r sr-figure, fig.height = 5, fig.cap = "Spawner-recruit data from nine watersheds. Solid lines are the spawner-recruit curve, dashed lines are the estimated capacity, and shaded polygons depict the 95% confidence intervals of capacity. Red corresponds to Beverton-Holt models, purple to Ricker models, blue to hockey stick models, and green to QRF estimates. The QRF solid curve is a Beverton-Holt model with the capacity parameter fixed to the QRF estimate of capacity. A few curves with high capacity estimates were not plotted to improve readability."}

spawn_rec_comp_p +
  theme(strip.text = element_text(size = 7))
```

<!-- The following line inserts a page break  -->
\newpage

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE, eval = T}
# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r, eval = T}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```
